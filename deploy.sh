#!/bin/bash

USER="root"
PASS="wytznTqhEsk6sdjY"
HOST="37.18.89.18"
REMOTE_DIR="/var/www/ff-website" 

# –í—ã–ø–æ–ª–Ω–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –∏ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
echo "üì¶ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ —Å —Å–µ—Ä–≤–µ—Ä–æ–º..."
sshpass -p "$PASS" rsync -avz \
  --exclude "node_modules/" \
  --exclude ".next/" \
  --exclude ".git/" \
  --delete -e ssh ./ "$USER@$HOST:$REMOTE_DIR"

# –ª–æ–≥–∏–∫–∞ –∫–æ–º–∞–Ω–¥—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: 
# 1) sshpass –¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è –ø–∞—Ä–æ–ª—è –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É
# 2) rsync -avz —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å—ë, —Å–æ—Ö—Ä–∞–Ω—è—è —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
# 3) --exclude –∏—Å–∫–ª—é—á–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞ —Å–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–¥–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –∫–∞—Ç–∞–ª–æ–≥ –±–∏–ª–¥–∞ (.next) –∏ –∫–∞—Ç–∞–ª–æ–≥ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (node_modules), —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –≤—Å–µ –±—É–¥–µ—Ç —Å–æ–±—Ä–∞–Ω–æ —É–∂–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
# 4) --delete —É–¥–∞–ª—è—Ç—å —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
# 5) ssh ./ (–∫–∞—Ç–∞–ª–æ–≥ –æ—Ç–∫—É–¥–∞ –±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ (—Ç–µ–∫—É—â–∏–π –∫–∞—Ç–∞–ª–æ–≥ –ø—Ä–æ–µ–∫—Ç–∞)) "$USER@$HOST:$REMOTE_DIR" (–æ—Ç –∫–∞–∫–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –Ω–∞ –∫–∞–∫–æ–π —Å–µ—Ä–≤–µ—Ä –∏ –≤ –∫–∞–∫–æ–π –∫–∞—Ç–∞–ª–æ–≥ –ø–æ–ª–æ–∂–∏—Ç—å —Ñ–∞–π–ª—ã)

echo -e "üöÄ –°–±–æ—Ä–∫–∞ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
sshpass -p "$PASS" ssh -T -o StrictHostKeyChecking=no "$USER@$HOST" << EOF
  set -e
  cd "$REMOTE_DIR"

  echo -e "\n \e[36m üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π... \e[0m \n " 
  npm install

  echo -e "\n  \e[36m üèóÔ∏è –°–±–æ—Ä–∫–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥... \e[0m \n " 
  TEMP_BUILD_DIR=build_temp npm run build

  echo -e "\n \e[36m üîÅ –ü–æ–¥–º–µ–Ω–∞ build_temp ‚Üí build \e[0m \n " 
  rm -rf .next
  mv build_temp .next

  echo -e "\n \e[36m ‚ôªÔ∏è –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ pm2... \e[0m \n " 
  pm2 restart finfactory-website || pm2 start npm --name "finfactory-website" -- start

  echo -e "\n  \e[32m ‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ! \e[0m"
  echo -e "   –ù–µ –∑–∞–±—É–¥—å—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å–∞–π—Ç–∞\n\n"
EOF

# –ª–æ–≥–∏–∫–∞ –∫–æ–º–∞–Ω–¥—ã —Å–±–æ—Ä–∫–∏ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞: 
# 1) "npm install" —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–≤—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å)
# 2) "TEMP_BUILD_DIR=build_temp npm run build" —Å–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥ "build_temp". –≠—Ç–æ —Å–¥–µ–ª–∞–Ω–æ –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –Ω–æ–≤–∞—è —Å–±–æ—Ä–∫–∞ –Ω–µ –ø—Ä–æ–π–¥–µ—Ç, —Ç–æ–≥–¥–∞ —Å—Ç–∞—Ä–∞—è —Å–±–æ—Ä–∫–∞ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –Ω–∞ –º–µ—Å—Ç–µ, –∞ –ø—Ä–æ—Ü–µ—Å—Å –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±—É–¥–µ—Ç—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
# 3) "rm -rf .next && mv build_temp .next" —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–π —Å–±–æ—Ä–∫–∞ –∏ –ø–æ–¥–º–µ–Ω–∞ –Ω–∞ –Ω–æ–≤—É—é
# 4) "pm2 restart finfactory-website || pm2 start npm --name "finfactory-website" -- start" –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å –∏–º–µ–Ω–µ–º finfactory-website, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É—Ç–∏–ª–∏—Ç–∞ pm2 (https://pm2.keymetrics.io/docs/usage/pm2-doc-single-page/)
